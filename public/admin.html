<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>Panel de clientes - Immigration Solutions for All</title>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      margin: 0;
      padding: 24px;
    }

    h1 {
      color: #0b3a75;
      margin-bottom: 8px;
    }

    .subtitle {
      color: #4b5563;
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    th,
    td {
      padding: 10px 12px;
      border-bottom: 1px solid #e5e7eb;
      font-size: 14px;
      vertical-align: top;
    }

    th {
      background: #0b3a75;
      color: white;
      text-align: left;
    }

    tr:last-child td {
      border-bottom: none;
    }

    select {
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 14px;
    }

    .status {
      font-weight: 600;
    }

    .updated {
      font-size: 12px;
      color: #6b7280;
    }

    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #e5e7eb;
      color: #374151;
    }

    .delete-btn {
      background-color: #dc2626;
      color: white;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }

    .delete-btn:hover {
      background-color: #b91c1c;
    }
  </style>
</head>

<body>
  <h1>Panel de clientes</h1>
  <div class="subtitle">
    AquÃ­ puedes ver los perfiles enviados desde la app, los documentos subidos y actualizar el
    <strong>estatus</strong> o <strong>eliminar</strong> clientes.
  </div>

  <table>
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Contacto</th>
        <th>Proceso</th>
        <th>Estatus</th>
        <th>Documentos</th>
        <th>Ãšltima actualizaciÃ³n</th>
        <th>Acciones</th>
      </tr>
    </thead>

    <tbody id="clients-body">
      <tr>
        <td colspan="7">Cargando clientes...</td>
      </tr>
    </tbody>
  </table>

  <script>
    const API_URL = window.location.origin;

    const STATUS_OPTIONS = [
      "Perfil recibido desde la app",
      "En revisiÃ³n",
      "Documentos incompletos",
      "Pendiente de firma",
      "Enviada a USCIS",
      "Respuesta recibida de USCIS",
      "Aprobado",
      "Denegado",
    ];

    function formatDate(dateStr) {
      if (!dateStr) return "-";
      const d = new Date(dateStr);
      return d.toLocaleString();
    }

    async function loadClients() {
      const tbody = document.getElementById("clients-body");

      try {
        const res = await fetch(`${API_URL}/clients`);
        const clients = await res.json();

        if (!clients.length) {
          tbody.innerHTML = "<tr><td colspan='7'>No hay clientes aÃºn.</td></tr>";
          return;
        }

        tbody.innerHTML = "";

        clients.forEach((c) => {
          const tr = document.createElement("tr");

          tr.innerHTML = `
            <td>
              <div class="status">${c.fullName || c.name || "-"}</div>
              <div class="updated">Estatus migratorio: ${c.immigrationStatus || "-"}</div>
            </td>

            <td>
              <div>${c.email || "-"}</div>
              <div class="updated">${c.phone || ""}</div>
            </td>

            <td>
              <span class="badge">${c.processType || "-"}</span>
            </td>

            <td>
              <select data-id="${c._id}">
                ${STATUS_OPTIONS.map(
                  (opt) => `
                  <option value="${opt}" ${c.status === opt ? "selected" : ""}>${opt}</option>
                `
                ).join("")}
              </select>
            </td>

            <td>
              ${
                c.documents && c.documents.length > 0
                  ? c.documents
                      .map(
                        (doc) => `
                    <div style="margin-bottom:6px;">
                      <a href="${doc.url}" 
                         target="_blank" 
                         style="color:#0B3A75; font-weight:600; text-decoration:underline;">
                        ðŸ“„ ${doc.name}
                      </a>
                      <div style="font-size:12px; color:#6b7280;">
                        (${new Date(doc.uploadedAt).toLocaleString()})
                      </div>
                    </div>
                  `
                      )
                      .join("")
                  : "No hay documentos"
              }
            </td>

            <td>
              <div class="updated">${formatDate(c.lastUpdate)}</div>
            </td>

            <td>
              <button class="delete-btn" onclick="deleteClient('${c._id}')">Eliminar</button>
            </td>
          `;

          tbody.appendChild(tr);
        });

        document.querySelectorAll("select[data-id]").forEach((selectEl) => {
          selectEl.addEventListener("change", () => {
            const id = selectEl.getAttribute("data-id");
            const newStatus = selectEl.value;
            updateStatus(id, newStatus);
          });
        });
      } catch (err) {
        console.error(err);
        tbody.innerHTML = "<tr><td colspan='7'>Error cargando clientes.</td></tr>";
      }
    }

    async function updateStatus(id, newStatus) {
      try {
        await fetch(`${API_URL}/clients/${id}/status`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ status: newStatus }),
        });

        loadClients();
      } catch (err) {
        alert("Error actualizando el estatus.");
      }
    }

    async function deleteClient(id) {
      if (!confirm("Â¿EstÃ¡s seguro de que deseas eliminar este cliente?")) return;

      try {
        await fetch(`${API_URL}/clients/${id}`, { method: "DELETE" });
        loadClients();
      } catch (err) {
        alert("Error eliminando cliente.");
      }
    }

    loadClients();
  </script>
</body>

</html>

